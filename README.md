# ytb-transcription

本项目是一个桌面端工具（Electron + React + TypeScript），用于把 YouTube 视频处理成可播放、可下载的目标语言语音。

核心流程：
- 下载视频（yt-dlp）
- 提取音频（ffmpeg）
- 语音转写（whisper）
- 文本翻译（可配置 Provider）
- 文本转语音（TTS）

## 翻译与 TTS 分段策略（最新）

### 1) 翻译分段（按上下文窗口阈值触发）

- 默认按大模型上下文窗口 `256k token` 估算，采用 `70%` 阈值触发分段（默认 `179200 token`）。
- 若转写全文估算 token 不超过阈值：**整段一次翻译**（不分段）。
- 若超过阈值：按 token 预算切成多个翻译片段，再按顺序逐段翻译。

默认行为要点：

- `user prompt` 仅放当前待翻译文本（当前分段原文）。
- `system prompt` 除基础翻译指令外，会附带“前一分段的尾部上下文”（用于连贯，不可重复翻译）。
- 合并翻译结果时，按顺序直接拼接（`\n` 连接）。

可配置项（任务快照 `modelConfigSnapshot`）：

- `translateSplitThresholdTokens`：翻译分段阈值（token）。
- `translationContextChars`：传给下一段的前文尾部上下文字符数。

### 2) TTS 分段（按标点切分，避免句子被硬截断）

- TTS 与翻译分段解耦，使用独立策略。
- 若翻译文本长度不超过阈值（默认 `3000` 字符）：**整段一次合成**。
- 若超过阈值：先按标点切成“句子单元”，再把句子单元聚合为目标长度片段（默认约 `900` 字符）。
- 聚合过程只在标点边界切分，**不强行按固定长度截断句子**，以降低句子不连贯问题。

可配置项（任务快照 `modelConfigSnapshot`）：

- `ttsSplitThresholdChars`：TTS 触发分段阈值（字符数）。
- `ttsTargetSegmentChars`：TTS 分段目标长度（字符数）。

说明：

- 为兼容历史参数，`ttsTargetSegmentChars` 未设置时，会优先参考 `segmentationOptions.maxCharsPerSegment / targetSegmentLength`，再回落到默认值。
- TTS 分段后仍会在合成阶段按段并发执行，并在最后自动拼接音频。

### 3) 调参建议（实践）

以下建议优先保证“稳定完成任务”，再优化“自然度/速度”。

按语言建议（`ttsTargetSegmentChars`）：

- 中文（`zh`）：建议 `700 ~ 1000`（默认 `900` 通常够用）。
- 英文（`en`）：建议 `900 ~ 1300`（词间空格多，可适当放大）。
- 日文（`ja`）：建议 `650 ~ 950`（句式更紧凑，适当保守更稳）。

按症状调参：

- 症状：TTS 偶发超时/失败  
  调整：先下调 `ttsTargetSegmentChars`（每次降 `100 ~ 200`），必要时下调 `ttsSplitThresholdChars` 让其更早分段。
- 症状：任务能成功，但语句衔接略生硬  
  调整：小幅上调 `ttsTargetSegmentChars`（每次升 `100` 左右），减少分段数量。
- 症状：短文本也被切得太碎  
  调整：上调 `ttsSplitThresholdChars`（例如从 `3000` 调到 `4000` 或更高）。

翻译侧建议：

- `translateSplitThresholdTokens` 一般保持默认（`179200`）即可。
- 仅当使用上下文窗口较小的模型时，再下调该值（例如到 `80k ~ 120k`）以提前分段，提升成功率。

## 近期更新（用户视角）

### 1. TTS Provider 支持「内置语音合成（Piper）」
- 设置页中的 TTS Provider 支持 `内置语音合成（Piper）`。
- 使用 Piper 时，不需要填写云端 TTS 的 API Key / Base URL。
- 对你最直接的好处是：大幅降低云端 TTS 成本。

### 2. 新增「一键安装 Piper」
- 选择 `内置语音合成（Piper）` 后，可以直接点击 `一键安装 Piper`。
- 应用会自动完成：
  - 下载并安装 Piper 运行环境
  - 下载默认音色模型
  - 自动填好 Piper 可执行文件、模型、配置路径
- 安装完成后可直接使用，不用再手动折腾命令行。

### 3. 旧版 custom 自动迁移
- 如果你之前使用过 `TTS Provider = custom`，应用会自动迁移为 `piper`，无需你手动处理。

### 4. 新增「检测 Piper 就绪状态」
- 设置页可点击 `检测 Piper 就绪状态`，快速确认本地环境是否可用。
- 会显示 `Binary / Model / Config` 三项状态，方便定位问题。

## 如何启用 Piper（给普通用户）

1. 打开设置页，选择 `TTS Provider = 内置语音合成（Piper）`。  
2. 点击 `一键安装 Piper`（首次安装会下载内容，可能需要几分钟）。  
3. 安装完成后，点击 `检测 Piper 就绪状态`，确认状态为就绪。  
4. 点击保存设置。  
5. 返回任务页，正常发起任务即可。  

如果你已经有自己的 Piper 和模型，也可以手动填写路径，不影响使用。

## Piper 常见报错与排查

### 1. 点击「一键安装 Piper」后报错
通常是网络问题或下载源访问受限。  

建议：
1. 换一个网络环境后重试。  
2. 如果你使用代理，确认系统代理可访问 GitHub / Hugging Face。  
3. 稍后再试一次（有时是上游短时波动）。  

### 2. 安装完成，但检测显示未就绪
通常是路径未刷新或模型文件不完整。  

建议：
1. 先点一次 `检测 Piper 就绪状态`。  
2. 再点一次保存设置。  
3. 仍不行时，重新点 `一键安装 Piper`。  

### 3. 想换别的音色/语言
- 最简单方式：修改目标语言后重新安装一次。  
- 进阶方式：手动填写你自己的模型路径和配置路径。  

## 开发与运行（本地）

```bash
npm install
npm run dev
```

质量检查：

```bash
npm run lint
npx tsc --noEmit
npm run build
```

## YouTube 下载鉴权方式对比（用户视角）

当你在应用里下载 YouTube 视频时，通常会在设置里看到两种鉴权方式：

- `Browser Cookies`（浏览器 Cookies）
- `Cookies File`（Cookies 文件）

下面是从日常使用角度的对比。

### 1. Browser Cookies：更省心，适合本机日常使用

你不需要手动导出文件，程序会直接读取你在设置中选择的浏览器当前登录态（默认是 Chrome）。

优点：

- 操作简单，开箱即用
- 登录态通常更新鲜，不容易因为过期导致下载失败
- 不需要额外保存敏感 cookies 文件，泄露风险相对更低

可能遇到的情况：

- 依赖本机已安装并登录的浏览器
- 在少数系统环境下，可能受浏览器权限或数据库占用影响

适合你如果：

- 在自己电脑上长期使用
- 希望少折腾、成功率稳定

### 2. Cookies File：更可控，适合跨设备或自动化

你需要先从浏览器导出一份 Netscape 格式 cookies 文件，然后在设置中指定文件路径。

优点：

- 可移植，方便在不同机器或无浏览器环境使用
- 自动化脚本/服务器场景更容易统一配置

可能遇到的情况：

- 文件会过期，需要定期重新导出
- 文件本身是敏感凭据，保管不当会有安全风险
- 过期或异常时，常见表现是重试变多、速度变慢或 403/401

适合你如果：

- 需要在多台机器复用同一套下载配置
- 运行环境没有可直接读取的浏览器登录态

### 3. 快速选择建议

- 优先选 `Browser Cookies`：大多数本机用户体验更稳定。
- 必须跨机器/自动化时再选 `Cookies File`。
- 若你已使用 `Cookies File` 且下载变慢、重试频繁，先重新导出 cookies 再测试。
