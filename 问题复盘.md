# 问题复盘

## 时间
- 2026-02-22

## 问题 1：任务已完成但页面未展示转写/翻译结果

### 现象
- `src/pages/TaskPage.tsx` 中结果区域依赖 `props.model.transcriptContent` 和 `props.model.translationContent` 显示。
- 实际任务处理完成后，页面仍不展示文本结果。

### 根因
- 任务完成事件 `onCompleted` 仅更新了 `output`（文件路径），没有在完成后读取文本并回填 `taskState`。
- `TaskPage` 的折叠区依赖 `taskState.transcriptContent` / `taskState.translationContent`，未回填即无内容可渲染。

### 修复
- 在 `src/app/hooks/useTaskEvents.ts` 的 `onCompleted` 中补充 `loadTaskContentAction(...)` 调用，完成时主动读取 `transcriptPath` 和 `translationPath` 并写回状态。
- 在以下流程中显式清空旧文本状态，避免任务切换时残留旧结果：
  - `startTaskAction`
  - `handleRetryHistoryTaskAction`
  - `loadTaskDetailAction`
  - 删除当前激活任务分支（`handleDeleteHistoryTaskAction`）
- 优化 `loadTaskContentAction`：
  - 当路径缺失时清空对应字段；
  - 当读取失败时清空对应字段并记日志；
  - 移除调试日志输出。

### 验证
- `npx tsc --noEmit` 通过。
- `npm run lint` 通过。
- 手动验证：任务完成后可在任务页看到转写与翻译结果内容。

---

## 问题 2：翻译结果存在局部重复（分段合并后）

### 现象
- 翻译结果中出现局部内容重复，集中发生在分段边界附近。

### 原因分析
- 翻译阶段在最终合并时直接 `join('\n')`，没有做边界去重。
- 模型在部分场景会把 `PREVIOUS_CONTEXT/NEXT_CONTEXT` 一并翻译进 `CURRENT_SEGMENT`，导致相邻段出现重叠文本。
- split fallback（超时后对子段重试翻译）内部也存在直接拼接路径，同样可能引入重复。

### 修复
- 在 `electron/core/task-engine/TaskEngine.ts` 新增翻译块合并去重逻辑：
  - `mergeTranslatedChunk(...)`
  - `mergeTranslatedChunks(...)`
- 将去重合并应用到两处：
  - split fallback 的子片段合并；
  - 翻译阶段最终分段结果合并（替换原 `join('\n')`）。
- 当检测并移除重叠文本时，增加日志：
  - `Translation merge removed duplicated overlap chars=...`
- 在 `electron/core/task-engine/minimax.ts` 增强翻译提示词约束：
  - 明确禁止翻译 `PREVIOUS_CONTEXT` / `NEXT_CONTEXT`；
  - 若出现上下文重复，要求模型先去重后输出。

### 验证
- `npx tsc --noEmit` 通过。
- `npm run lint` 通过。
- 预期效果：相邻分段重复显著减少；即使模型偶发带出上下文，也会在合并阶段进行兜底去重。

---

## 问题 3：Whisper 转录阶段报 SSL EOF（MLX/HuggingFace 下载）

### 现象
- 转录阶段日志出现 `httpcore.ConnectError: [SSL: UNEXPECTED_EOF_WHILE_READING]`。
- 调用栈经过 `http_proxy.py` 和 `huggingface_hub._snapshot_download`，任务在 `transcribing` 阶段失败。

### 根因
- Apple Silicon 下优先走 MLX 路径时，模型从 HuggingFace 拉取。
- 运行环境存在代理链路时，TLS 握手偶发异常（EOF），导致下载中断。
- 下载未成功落盘时，本地缓存未建立，后续任务会再次触发下载尝试，体验上像“每次都在下载”。

### 修复
- 在 `electron/core/task-engine/TaskEngine.ts` 的 MLX 执行脚本中先尝试：
  - `snapshot_download(..., local_files_only=True)`（优先命中本地缓存）；
  - 本地无缓存时再走联网下载。
- 增加代理异常识别与兜底重试：
  - 捕获本次 stderr；
  - 若识别为代理/TLS 相关错误，自动进行一次“无代理环境变量”重试（清空 `HTTP(S)_PROXY/ALL_PROXY`，设置 `NO_PROXY=*`）。

### 验证
- `npm run lint -- electron/core/task-engine/TaskEngine.ts` 通过。
- `npx tsc --noEmit` 通过。
- 预期效果：首次下载成功后，同模型后续任务优先复用缓存；遇到代理 TLS 异常时可自动兜底重试。

---

## 问题 4：History 页面点击“恢复”报错 `No checkpoint found`

### 现象
- 在 `src/pages/HistoryPage.tsx` 点击“恢复”时，部分失败任务直接报 `No checkpoint found`，无法续跑。
- 该问题在“转录阶段失败”的任务上稳定出现。

### 根因
- `resumeFromCheckpoint` 旧逻辑强依赖 `task_recovery_snapshots`。
- 但 checkpoint 仅在分段阶段写入（翻译/合成成功分段后保存）；转录失败时通常没有 checkpoint。
- 因此恢复请求被直接拒绝。

### 修复
- 在 `electron/core/task-engine/TaskEngine.ts` 增加“无 checkpoint 的恢复兜底”：
  - 根据最近失败/运行的 step 推断首选恢复阶段；
  - 结合已有 artifact（video/audio/transcript/translation/tts）回退到可执行的最近阶段；
  - 若有未完成分段，自动构建 retry 集合。
- 即使没有 checkpoint，也可启动恢复流程，不再直接报错。

### 验证
- `npm run lint -- electron/core/task-engine/TaskEngine.ts` 通过。
- `npx tsc --noEmit` 通过。
- 手动验证：对转录阶段失败任务点击“恢复”可正常受理并重新进入执行。

## 后续观察点
- 关注日志中 `Translation merge removed duplicated overlap chars` 的出现频率与字符数。
- 如误删真实重复语句（如歌词副歌）出现，可在后续引入“阈值化去重”开关（按重叠比例/长度触发）。
- 关注日志 `MLX download hit proxy TLS error, retrying once without proxy env` 的出现频率，评估是否需要提供用户可配置代理策略。
- 关注“无 checkpoint 恢复”触发次数，若频繁触发可在历史页补充恢复来源说明（checkpoint/fallback）。
