# 问题复盘

## 时间
- 2026-02-22

## 问题 1：任务已完成但页面未展示转写/翻译结果

### 现象
- `src/pages/TaskPage.tsx` 中结果区域依赖 `props.model.transcriptContent` 和 `props.model.translationContent` 显示。
- 实际任务处理完成后，页面仍不展示文本结果。

### 根因
- 任务完成事件 `onCompleted` 仅更新了 `output`（文件路径），没有在完成后读取文本并回填 `taskState`。
- `TaskPage` 的折叠区依赖 `taskState.transcriptContent` / `taskState.translationContent`，未回填即无内容可渲染。

### 修复
- 在 `src/app/hooks/useTaskEvents.ts` 的 `onCompleted` 中补充 `loadTaskContentAction(...)` 调用，完成时主动读取 `transcriptPath` 和 `translationPath` 并写回状态。
- 在以下流程中显式清空旧文本状态，避免任务切换时残留旧结果：
  - `startTaskAction`
  - `handleRetryHistoryTaskAction`
  - `loadTaskDetailAction`
  - 删除当前激活任务分支（`handleDeleteHistoryTaskAction`）
- 优化 `loadTaskContentAction`：
  - 当路径缺失时清空对应字段；
  - 当读取失败时清空对应字段并记日志；
  - 移除调试日志输出。

### 验证
- `npx tsc --noEmit` 通过。
- `npm run lint` 通过。
- 手动验证：任务完成后可在任务页看到转写与翻译结果内容。

---

## 问题 2：翻译结果存在局部重复（分段合并后）

### 现象
- 翻译结果中出现局部内容重复，集中发生在分段边界附近。

### 原因分析
- 翻译阶段在最终合并时直接 `join('\n')`，没有做边界去重。
- 模型在部分场景会把 `PREVIOUS_CONTEXT/NEXT_CONTEXT` 一并翻译进 `CURRENT_SEGMENT`，导致相邻段出现重叠文本。
- split fallback（超时后对子段重试翻译）内部也存在直接拼接路径，同样可能引入重复。

### 修复
- 在 `electron/core/task-engine/TaskEngine.ts` 新增翻译块合并去重逻辑：
  - `mergeTranslatedChunk(...)`
  - `mergeTranslatedChunks(...)`
- 将去重合并应用到两处：
  - split fallback 的子片段合并；
  - 翻译阶段最终分段结果合并（替换原 `join('\n')`）。
- 当检测并移除重叠文本时，增加日志：
  - `Translation merge removed duplicated overlap chars=...`
- 在 `electron/core/task-engine/minimax.ts` 增强翻译提示词约束：
  - 明确禁止翻译 `PREVIOUS_CONTEXT` / `NEXT_CONTEXT`；
  - 若出现上下文重复，要求模型先去重后输出。

### 验证
- `npx tsc --noEmit` 通过。
- `npm run lint` 通过。
- 预期效果：相邻分段重复显著减少；即使模型偶发带出上下文，也会在合并阶段进行兜底去重。

## 后续观察点
- 关注日志中 `Translation merge removed duplicated overlap chars` 的出现频率与字符数。
- 如误删真实重复语句（如歌词副歌）出现，可在后续引入“阈值化去重”开关（按重叠比例/长度触发）。
